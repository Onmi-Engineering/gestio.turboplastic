<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- External layout for export invoices -->
        <template id="onmi_external_layout_export_invoice">
            <t t-if="not o" t-set="o" t-value="doc"/>

            <t t-if="not company">
                <!-- Multicompany -->
                <t t-if="company_id">
                    <t t-set="company" t-value="company_id"/>
                </t>
                <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                    <t t-set="company" t-value="o.company_id.sudo()"/>
                </t>
                <t t-else="">
                    <t t-set="company" t-value="res_company"/>
                </t>
            </t>

            <t t-call="onmi_turbo_credit_note.onmi_external_layout_standard_export_invoice">
                <t t-out="0"/>
            </t>
        </template>

        <!-- External layout standard for export invoices - based on striped layout -->
        <template id="onmi_external_layout_standard_export_invoice">
            <div t-attf-class="header o_company_#{company.id}_layout" t-att-style="report_header_style">
                <div class="row">
                    <div class="col-3 mb4">
                        <img t-if="company.logo" t-att-src="image_data_uri(company.logo)" style="max-height: 45px;"
                             alt="Logo"/>
                    </div>
                    <div class="col-9 text-end" style="margin-top:22px;" t-field="company.report_header" name="moto"/>
                </div>
                <div t-if="company.logo or company.report_header" class="row zero_min_height">
                    <div class="col-12">
                        <div style="border-bottom: 1px solid black;"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6" name="company_address">
                        <span t-if="company.company_details_export" t-field="company.company_details_export"/>
                        <span t-elif="company.company_details" t-field="company.company_details"/>
                    </div>
                </div>
            </div>

            <div t-attf-class="article o_report_layout_standard o_company_#{company.id}_layout"
                 t-att-data-oe-model="o and o._name"
                 t-att-data-oe-id="o and o.id"
                 t-att-data-oe-lang="o and o.env.context.get('lang')">
                <t t-out="0"/>
            </div>

            <div t-attf-class="footer o_standard_footer o_company_#{company.id}_layout">
                <div class="text-center" style="border-top: 1px solid black;">
                    <ul class="list-inline mb4">
                        <div t-if="company.report_footer_export" t-field="company.report_footer_export"/>
                        <div t-elif="company.report_footer" t-field="company.report_footer"/>
                    </ul>
                    <div t-if="report_type == 'pdf'" class="text-muted">
                        Page: <span class="page"/> / <span class="topage"/>
                    </div>
                </div>
            </div>
        </template>

        <!-- Main document template for export invoice -->
        <template id="onmi_report_exportacion_document">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-set="o" t-value="doc"/>
                    <t t-call="onmi_turbo_credit_note.onmi_external_layout_export_invoice">
                        <t t-call="onmi_turbo_credit_note.onmi_report_exportacion_content"/>
                    </t>
                </t>
            </t>
        </template>

        <!-- Content template for export invoice (separated for easier inheritance) -->
        <template id="onmi_report_exportacion_content">
            <style>
                .export-invoice .page {
                font-size: 12px !important;
                padding: 0 !important;
                margin: 0 !important;
                }
                .export-invoice .h2 {
                font-size: 18px !important;
                margin-top: 3px !important;
                margin-bottom: 3px !important;
                }
                .export-invoice .table {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                table-layout: fixed;
                width: 100%;
                }
                .export-invoice span {
                font-size: 12px !important;
                line-height: 1.1 !important;
                }
                .export-invoice strong {
                font-size: 12px !important;
                }
                .export-invoice .table td,
                .export-invoice .table th {
                padding: 2px !important;
                vertical-align: top !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                word-break: break-word !important;
                }
                .export-invoice .row {
                margin-bottom: 3px !important;
                margin-top: 0 !important;
                }
                .export-invoice .col-3,
                .export-invoice .col-4,
                .export-invoice .col-5,
                .export-invoice .col-6 {
                padding-right: 3px !important;
                padding-left: 3px !important;
                }
                .export-invoice span br {
                line-height: 0.9 !important;
                }
                .export-invoice .table-sm td {
                padding: 1px !important;
                }
                .export-invoice .invoice-header-row {
                margin-top: 10px !important;
                margin-bottom: 15px !important;
                }
                .export-invoice .label-value {
                margin-bottom: 5px !important;
                }
            </style>

            <div class="export-invoice">
                <div class="page">
                    <!-- Address section -->
                    <div class="row address">
                        <div class="col-5">
                            <span t-if="o.company_id.company_details_export"
                                  t-field="o.company_id.company_details_export"/>
                            <span t-elif="o.company_id.company_details" t-field="o.company_id.company_details"/>
                        </div>
                        <div class="col-5 offset-2">
                            <div t-field="o.partner_id"
                                 t-options='{"widget": "contact", "fields": ["name", "address", "phone", "mobile", "email", "vat"]}'
                                 class="small"/>
                        </div>
                    </div>

                    <!-- Document title -->
                    <div class="row" style="margin-top: 15px; margin-bottom: 15px;">
                        <div class="col h2">
                            <t t-if="o.move_type in ('out_refund', 'in_refund')">
                                <span>CREDIT NOTE</span>
                            </t>
                            <t t-else="">
                                <span>INVOICE</span>
                            </t>
                        </div>
                    </div>

                    <!-- Invoice header info -->
                    <div class="row invoice-header-row">
                        <div class="col-4">
                            <div class="label-value">
                                <t t-if="o.move_type in ('out_refund', 'in_refund')">
                                    <strong>CREDIT NOTE NO:</strong>
                                </t>
                                <t t-else="">
                                    <strong>INVOICE NO:</strong>
                                </t>
                            </div>
                            <span t-field="o.name"/>
                        </div>
                        <div class="col-4">
                            <div class="label-value">
                                <t t-if="o.move_type in ('out_refund', 'in_refund')">
                                    <strong>CREDIT NOTE DATE:</strong>
                                </t>
                                <t t-else="">
                                    <strong>INVOICE DATE:</strong>
                                </t>
                            </div>
                            <span t-field="o.date"/>
                        </div>
                        <div class="col-4">
                            <div class="label-value">
                                <strong>CONTRAT NO:</strong>
                            </div>
                            <span t-field="o.x_studio_contrat_no"/>
                        </div>
                    </div>

                    <!-- Lines table -->
                    <table class="table o_report_block_table" name="invoice_lines_table">
                        <thead>
                            <tr>
                                <th><span>Packages</span></th>
                                <th><span>Type pack</span></th>
                                <th><span>Container no</span></th>
                                <th><span>Seal No</span></th>
                                <th><span>Description</span></th>
                                <th><span>Gross Weight</span></th>
                                <th><span>Net Weight</span></th>
                                <th><span>Price</span></th>
                                <th><span>Amount</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="o.invoice_line_ids" t-as="line">
                                <t t-if="line.display_type not in ('line_section', 'line_note')">
                                    <tr>
                                        <td>
                                            <span t-field="line.x_studio_packages"/>
                                        </td>
                                        <td>
                                            <span t-field="line.inv_package_type"/>
                                        </td>
                                        <td>
                                            <span t-field="line.x_studio_container_no"/>
                                        </td>
                                        <td>
                                            <span t-field="line.x_studio_seal_no"/>
                                        </td>
                                        <td name="line_description">
                                            <span t-field="line.name"/>
                                        </td>
                                        <td>
                                            <span t-field="line.x_studio_gross_weight"/>
                                            <span t-field="line.product_uom_id.name"/>
                                        </td>
                                        <td>
                                            <span t-field="line.quantity"/>
                                            <span t-field="line.product_uom_id.name"/>
                                        </td>
                                        <td>
                                            <span t-field="line.price_unit"/>
                                            <span t-field="line.currency_id.symbol"/>
                                        </td>
                                        <td>
                                            <t t-if="o.move_type in ('out_refund', 'in_refund')">
                                                <span t-field="line.inverse_subtotal"/>
                                                <span t-field="line.currency_id.symbol"/>
                                            </t>
                                            <t t-else="">
                                                <span t-field="line.price_subtotal"/>
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                                <t t-else="">
                                    <tr>
                                        <td colspan="9">
                                            <span t-field="line.name"/>
                                        </td>
                                    </tr>
                                </t>
                            </t>
                        </tbody>
                    </table>

                    <!-- Totals row: HS Code, Total kg, Total Packages -->
                    <div class="row" style="margin-top: 10px;" name="totals_row">
                        <div class="col-4">
                            <div class="label-value">
                                <strong>HS CODE:</strong>
                            </div>
                            <span t-field="o.x_studio_hs_code"/>
                        </div>
                        <div class="col-4" name="total_kg_section">
                            <div class="label-value">
                                <strong>TOTAL (kg):</strong>
                            </div>
                            <span t-field="o.total_kg"/>
                        </div>
                        <div class="col-4">
                            <div class="label-value">
                                <strong>TOTAL (Packages):</strong>
                            </div>
                            <span t-field="o.total_pkg"/>
                        </div>
                    </div>

                    <!-- Amounts summary -->
                    <div class="row" style="margin-top: 10px;" name="amounts_summary">
                        <div class="col-6"/>
                        <div class="col-6">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Subtotal</strong></td>
                                    <td class="text-end">
                                        <t t-if="o.move_type in ('out_refund', 'in_refund')">
                                            <span t-field="o.inverse_total_untaxes"/>
                                        </t>
                                        <t t-else="">
                                            <span t-field="o.amount_untaxed"/>
                                        </t>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total</strong></td>
                                    <td class="text-end">
                                        <t t-if="o.move_type in ('out_refund', 'in_refund')">
                                            <span t-field="o.inverse_total_taxes"/>
                                        </t>
                                        <t t-else="">
                                            <span t-field="o.amount_total"/>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Incoterm and origin -->
                    <div class="row" style="margin-top: 10px;" name="incoterm_origin">
                        <div class="col-3">
                            <div class="label-value">
                                <strong>INCOTERM:</strong>
                            </div>
                            <span t-field="o.invoice_incoterm_id.name"/>
                        </div>
                        <div class="col-3">
                            <div class="label-value">
                                <strong>ORIGIN:</strong>
                            </div>
                            <span t-field="o.x_studio_origin"/>
                        </div>
                        <div class="col-3"/>
                        <div class="col-3"/>
                    </div>

                    <!-- Ports -->
                    <div name="ports" class="row" style="margin-top: 5px;">
                        <div class="col-3">
                            <div class="label-value">
                                <strong>PORT OF LOADING:</strong>
                            </div>
                            <span t-field="o.x_studio_port_of_loading"/>
                        </div>
                        <div class="col-3">
                            <div class="label-value">
                                <strong>PORT OF DISCHARGE:</strong>
                            </div>
                            <span t-field="o.x_studio_port_of_discharge"/>
                        </div>
                        <div class="col-3"/>
                        <div class="col-3"/>
                    </div>

                    <!-- Company and bank details footer section -->
                    <div class="row" style="margin-top: 15px;" name="company_bank_details">
                        <div class="col-6" name="company_footer_details">
                            <span t-if="o.company_id.company_details_export"
                                  t-field="o.company_id.company_details_export"/>
                            <span t-elif="o.company_id.company_details" t-field="o.company_id.company_details"/>
                        </div>
                        <div name="accounts" class="col-6 text-end">
                            <!-- Bank accounts will be inherited by other modules -->
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Report action wrapper -->
        <template id="onmi_report_exportacion">
            <t t-foreach="docs" t-as="o">
                <t t-call="onmi_turbo_credit_note.onmi_report_exportacion_document"
                   t-options-lang="o.partner_id.lang"/>
            </t>
        </template>

    </data>
</odoo>
